# platform/macos-iterm2.conf
#
# macOS + iTerm2 兜底（可选加载）
# - 主要解决：Option 作为 Normal 导致的特殊字符、以及 iTerm2 Send Hex 的 user-keys 映射

# iTerm2 兼容：如果某个 Option 键被设为 Normal，Option+X 会发出 ≈（而不是 M-x）
bind -N 'iTerm2：≈（Option+x）关闭 pane（双击确认）' -n ≈ run-shell -b "~/.config/tmux/scripts/kill_pane_double_tap.sh \"#{pane_id}\" \"#{client_name}\" \"#{client_pid}\""
# iTerm2 兼容：如果某个 Option 键被设为 Normal，Option+Shift+Q 会发出 Œ（而不是 M-Q）
bind -N 'iTerm2：Œ（Option+Shift+Q）关闭 window（确认）' -n Œ confirm-before -p "kill-window #W? (y/n)" kill-window

# iTerm2 兼容：如果某个 Option 键被设为 Normal，Option+/ 会发出 ÷（而不是 M-/）
bind -N 'iTerm2：÷（Option+/）开关 nvim 弹窗' -n ÷ if-shell -F "#{&&:#{==:#{@nvim_popup_open},1},#{==:#{@nvim_popup_client},#{client_name}}}" \
  "run-shell -b \"nvim --server /tmp/nvim-tmux-popup-#{client_pid}.sock --remote-send '<Esc>:confirm qa<CR>' >/dev/null 2>&1 && exit 0; tmux display-popup -C; tmux set -gu @nvim_popup_open; tmux set -gu @nvim_popup_client\"" \
  "display-popup -C; set -g @nvim_popup_open 1; set -gF @nvim_popup_client '#{client_name}'; display-popup -E -w 90% -h 90% -T \"nvim\" -d \"#{pane_current_path}\" -e \"NVIM_POPUP=1\" \"sh -lc 'rm -f /tmp/nvim-tmux-popup-#{client_pid}.sock; nvim --listen /tmp/nvim-tmux-popup-#{client_pid}.sock -c \\\"silent! NvimTreeOpen\\\" -c \\\"wincmd p\\\"; rm -f /tmp/nvim-tmux-popup-#{client_pid}.sock; tmux set -gu @nvim_popup_open; tmux set -gu @nvim_popup_client'\""

# 兼容：避免 reload 时残留旧绑定
unbind -n œ
unbind -n User1
unbind -n User2
unbind -T copy-mode-vi User1
unbind -T copy-mode-vi User2
unbind -T copy-mode User1
unbind -T copy-mode User2

# 为 Cmd 系快捷键预留：终端侧把按键映射成自定义转义序列，tmux 用 user-keys 识别为 User0
# - iTerm2：Profiles → Keys → Key Mappings 添加 Shift+Cmd+Enter → Send Hex Codes: 0x1b 0x5b 0x39 0x39 0x7e
set -s user-keys[0] "\e[99~"
bind -N 'iTerm2：User0（Shift+Cmd+Enter）缩放 pane' -n User0 resize-pane -Z

# iTerm2 可选兜底：若 Option+[ / Option+] 因输入法/系统快捷键导致 M-[ / M-] 不稳定，可映射为自定义序列，再由 user-keys 捕获为 User1 / User2
# - iTerm2：Profiles → Keys → Key Mappings
#   - Option+[ → Send Hex Codes: 0x1b 0x5b 0x31 0x30 0x30 0x7e  # \e[100~
#   - Option+] → Send Hex Codes: 0x1b 0x5b 0x31 0x30 0x31 0x7e  # \e[101~
set -s user-keys[1] "\e[100~"
set -s user-keys[2] "\e[101~"

# iTerm2 可选兜底：若 Option+- / Option+= 因输入法/终端差异导致 M-- / M-= 不稳定，可映射为自定义序列，再由 user-keys 捕获为 User7 / User8
# - iTerm2：Profiles → Keys → Key Mappings
#   - Option+- → Send Hex Codes: 0x1b 0x5b 0x31 0x31 0x30 0x7e  # \e[110~
#   - Option+= → Send Hex Codes: 0x1b 0x5b 0x31 0x31 0x31 0x7e  # \e[111~
set -s user-keys[7] "\e[110~"
set -s user-keys[8] "\e[111~"
bind -N 'iTerm2：User7（Option+-）window 左移' -n User7 swap-window -d -t :-1
bind -N 'iTerm2：User8（Option+=）window 右移' -n User8 swap-window -d -t :+1

# iTerm2 推荐兜底：若 Shift+Option+-/=/[/] 在某些输入法/配置下不稳定，
# 可映射为自定义序列，再由 user-keys 捕获为 User9..User12（不依赖 Meta/F6..F9）。
# - iTerm2：Profiles → Keys → Key Mappings
#   - Shift+Option+- → Send Hex Codes: 0x1b 0x5b 0x31 0x31 0x32 0x7e  # \e[112~
#   - Shift+Option+= → Send Hex Codes: 0x1b 0x5b 0x31 0x31 0x33 0x7e  # \e[113~
#   - Shift+Option+[ → Send Hex Codes: 0x1b 0x5b 0x31 0x31 0x34 0x7e  # \e[114~
#   - Shift+Option+] → Send Hex Codes: 0x1b 0x5b 0x31 0x31 0x35 0x7e  # \e[115~
set -s user-keys[9] "\e[112~"
set -s user-keys[10] "\e[113~"
set -s user-keys[11] "\e[114~"
set -s user-keys[12] "\e[115~"

# pane resizing：终端侧把 Shift+Option+I/J/K/L 映射成自定义转义序列，tmux 用 user-keys 识别为 User3..User6（更稳定）
# - iTerm2：Profiles → Keys → Key Mappings
#   - Shift+Option+I → Send Hex Codes: 0x1b 0x5b 0x31 0x30 0x32 0x7e  # \e[102~
#   - Shift+Option+J → Send Hex Codes: 0x1b 0x5b 0x31 0x30 0x33 0x7e  # \e[103~
#   - Shift+Option+K → Send Hex Codes: 0x1b 0x5b 0x31 0x30 0x34 0x7e  # \e[104~
#   - Shift+Option+L → Send Hex Codes: 0x1b 0x5b 0x31 0x30 0x35 0x7e  # \e[105~
set -s user-keys[3] "\e[102~"
set -s user-keys[4] "\e[103~"
set -s user-keys[5] "\e[104~"
set -s user-keys[6] "\e[105~"
bind -N 'iTerm2：User3 resize 上 3' -n User3 resize-pane -U 3
bind -N 'iTerm2：User4 resize 左 3' -n User4 resize-pane -L 3
bind -N 'iTerm2：User5 resize 下 3' -n User5 resize-pane -D 3
bind -N 'iTerm2：User6 resize 右 3' -n User6 resize-pane -R 3

# iTerm2 稳定兜底：将 Shift+Option+I/J/K/L 映射为单字节控制码，再由 tmux 捕获执行 resize
# - I(上)   -> C-Space (0x00)
# - J(左)   -> C-]     (0x1d)
# - K(下)   -> C-^     (0x1e)
# - L(右)   -> C-_     (0x1f)
# - iTerm2：Profiles → Keys → Key Mappings
#   - Shift+Option+I → Send Hex Codes: 0x00
#   - Shift+Option+J → Send Hex Codes: 0x1d
#   - Shift+Option+K → Send Hex Codes: 0x1e
#   - Shift+Option+L → Send Hex Codes: 0x1f
bind -N 'iTerm2：Ctrl-Space resize 上 3' -n C-Space resize-pane -U 3
bind -N 'iTerm2：Ctrl-] resize 左 3' -n C-] resize-pane -L 3
bind -N 'iTerm2：Ctrl-^ resize 下 3' -n C-^ resize-pane -D 3
bind -N 'iTerm2：Ctrl-_ resize 右 3' -n C-_ resize-pane -R 3

# session switching (no prefix; session = window + Shift) 的 user-keys 兜底（User11/12 = Shift+Option+[/]）
bind -N 'iTerm2：User11 切 session 左' -n User11 run-shell -b "~/.config/tmux/scripts/switch_session_relative.sh left \"#{client_name}\""
bind -N 'iTerm2：User12 切 session 右' -n User12 run-shell -b "~/.config/tmux/scripts/switch_session_relative.sh right \"#{client_name}\""
bind -N 'copy-mode：切 session 左（User11）' -T copy-mode-vi User11 run-shell -b "~/.config/tmux/scripts/switch_session_relative.sh left \"#{client_name}\""
bind -N 'copy-mode：切 session 右（User12）' -T copy-mode-vi User12 run-shell -b "~/.config/tmux/scripts/switch_session_relative.sh right \"#{client_name}\""
bind -N 'copy-mode：切 session 左（User11）' -T copy-mode User11 run-shell -b "~/.config/tmux/scripts/switch_session_relative.sh left \"#{client_name}\""
bind -N 'copy-mode：切 session 右（User12）' -T copy-mode User12 run-shell -b "~/.config/tmux/scripts/switch_session_relative.sh right \"#{client_name}\""

# window ordering 的 user-keys 兜底（User7/8 = Option+-/=）
bind -N 'copy-mode：window 左移（User7）' -T copy-mode-vi User7 swap-window -d -t :-1
bind -N 'copy-mode：window 右移（User8）' -T copy-mode-vi User8 swap-window -d -t :+1
bind -N 'copy-mode：window 左移（User7）' -T copy-mode User7 swap-window -d -t :-1
bind -N 'copy-mode：window 右移（User8）' -T copy-mode User8 swap-window -d -t :+1
# 兜底：若第三方输入法/系统快捷键导致 Option+-/= 的 Meta 被吞，可将其映射为 F8/F9
bind -N '兜底：F8 window 左移' -n F8 swap-window -d -t :-1
bind -N '兜底：F9 window 右移' -n F9 swap-window -d -t :+1
bind -N 'copy-mode：F8 window 左移' -T copy-mode-vi F8 swap-window -d -t :-1
bind -N 'copy-mode：F9 window 右移' -T copy-mode-vi F9 swap-window -d -t :+1
bind -N 'copy-mode：F8 window 左移' -T copy-mode F8 swap-window -d -t :-1
bind -N 'copy-mode：F9 window 右移' -T copy-mode F9 swap-window -d -t :+1

# window switching 的 user-keys 兜底（User1/2 = Option+[/]）

# session ordering 的 user-keys 兜底（User9/10 = Shift+Option+-/=）
bind -N 'iTerm2：User9 session 左移' -n User9 run-shell -b "~/.config/tmux/scripts/move_session.sh left \"#{client_name}\""
bind -N 'iTerm2：User10 session 右移' -n User10 run-shell -b "~/.config/tmux/scripts/move_session.sh right \"#{client_name}\""
bind -N 'copy-mode：session 左移（User9）' -T copy-mode-vi User9 run-shell -b "~/.config/tmux/scripts/move_session.sh left \"#{client_name}\""
bind -N 'copy-mode：session 右移（User10）' -T copy-mode-vi User10 run-shell -b "~/.config/tmux/scripts/move_session.sh right \"#{client_name}\""
bind -N 'copy-mode：session 左移（User9）' -T copy-mode User9 run-shell -b "~/.config/tmux/scripts/move_session.sh left \"#{client_name}\""
bind -N 'copy-mode：session 右移（User10）' -T copy-mode User10 run-shell -b "~/.config/tmux/scripts/move_session.sh right \"#{client_name}\""
