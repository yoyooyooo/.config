# core/hooks.conf
#
# hooks + 启动时 bootstrap（尽量跨平台）

# Clear older activity hooks (keeps activity purely flag-based in status line)
set-hook -gu alert-activity

set-hook -g pane-focus-in "run -b 'bash ~/.config/tmux/scripts/scripts_popup.sh update_mru_pane_ids'"

set-hook -gu client-attached
# set-hook -g client-attached 'run -b "cut -c3- ~/.config/tmux/tmux.conf | sh -s update_env_event"'
# Acknowledge the current pane's task when a client attaches (graceful if tracker unavailable)
set-hook -ag client-attached 'run -b "test -x ~/.config/agent-tracker/bin/tracker-client && ~/.config/agent-tracker/bin/tracker-client command acknowledge --client #{client_tty} --session-id #{session_id} --window-id #{window_id} --pane #{pane_id} || true"'
set-hook -ag client-attached 'run -b -t "#{pane_id}" "~/.config/tmux/scripts/ensure_pane_output_watch.sh --all"'
set-hook -ag client-attached 'run -b "tmux refresh-client -S"'

# set-hook -gu client-resized
# set-hook -ag client-resized 'run -b "tmux refresh-client -S"'

set-hook -ag pane-focus-in 'run -b "test -x ~/.config/agent-tracker/bin/tracker-client && ~/.config/agent-tracker/bin/tracker-client command acknowledge --client #{client_tty} --session-id #{session_id} --window-id #{window_id} --pane #{pane_id} || true"'
set-hook -ag pane-focus-in 'run -b "tmux refresh-client -S"'
set-hook -ag pane-focus-in 'run -b "~/.config/tmux/scripts/codex_notify_ack_turn_complete.sh #{pane_id} >/dev/null 2>&1 || true"'
set-hook -ag pane-focus-in 'run -b "tmux set -p -t #{pane_id} @unread_pane_activity 0 >/dev/null 2>&1 || true"'
set-hook -ag pane-focus-in 'run -b "~/.config/tmux/scripts/sync_window_unread_activity.sh #{window_id} >/dev/null 2>&1 || true"'
set-hook -ag pane-focus-in 'run -b "tmux set -p -t #{pane_id} @unread_ignore_activity 0 >/dev/null 2>&1 || true"'
set-hook -ag pane-focus-in 'run -b "tmux set -p -t #{pane_id} @unread_ignore_checked 0 >/dev/null 2>&1 || true"'
set-hook -ag pane-focus-in 'run -b "tmux set -p -t #{pane_id} @unread_ignore_check_count 0 >/dev/null 2>&1 || true"'
set-hook -ag pane-focus-in 'run -b "tmux set -p -t #{pane_id} @unread_ignore_checked_at 0 >/dev/null 2>&1 || true"'
set-hook -gu pane-died
set-hook -ag pane-died 'run -b "test -x ~/.config/agent-tracker/bin/tracker-client && ~/.config/agent-tracker/bin/tracker-client command delete_task --client #{client_tty} --session-id #{session_id} --window-id #{window_id} --pane #{pane_id} || true"'
set-hook -ag pane-died 'run -b "test -x ~/.config/agent-tracker/bin/tracker-client && ~/.config/agent-tracker/bin/tracker-client command note_archive_pane --client #{client_tty} --session-id #{session_id} --window-id #{window_id} --pane #{pane_id} || true"'

# -- Project-specific window activation hooks
# Checks for ./on-tmux-window-activate.sh or ../on-tmux-window-activate.sh and runs it
set-hook -gu after-select-pane
set-hook -gu after-select-window
set-hook -gu after-split-window
set-hook -gu after-kill-pane
set-hook -gu after-new-window
set-hook -ag after-new-window 'run -b -t "#{hook_pane}" "~/.config/tmux/scripts/ensure_pane_output_watch.sh #{hook_pane}"'
set-hook -ag after-split-window 'run -b -t "#{hook_pane}" "~/.config/tmux/scripts/ensure_pane_output_watch.sh #{hook_pane}"'
set-hook -ag after-select-pane 'run -b "~/.config/tmux/scripts/auto_cancel_copy_mode_near_bottom.sh \"#{hook_pane}\" \"#{pane_id}\""'
set-hook -ag after-select-pane 'run -b "tmux set -p -t #{pane_id} @unread_pane_activity 0 >/dev/null 2>&1 || true"'
set-hook -ag after-select-pane 'run -b "~/.config/tmux/scripts/sync_window_unread_activity.sh #{window_id} >/dev/null 2>&1 || true"'
set-hook -ag after-select-pane 'run -b "~/.config/tmux/scripts/codex_notify_ack_turn_complete.sh #{pane_id} >/dev/null 2>&1 || true"'
set-hook -ag after-select-pane 'run -b "tmux set -p -t #{pane_id} @unread_ignore_activity 0 >/dev/null 2>&1 || true"'
set-hook -ag after-select-pane 'run -b "tmux set -p -t #{pane_id} @unread_ignore_checked 0 >/dev/null 2>&1 || true"'
set-hook -ag after-select-pane 'run -b "tmux set -p -t #{pane_id} @unread_ignore_check_count 0 >/dev/null 2>&1 || true"'
set-hook -ag after-select-pane 'run -b "tmux set -p -t #{pane_id} @unread_ignore_checked_at 0 >/dev/null 2>&1 || true"'
set-hook -ag after-select-window 'run-shell "~/.config/tmux/scripts/check_and_run_on_activate.sh \"#{pane_current_path}\""'
set-hook -ag after-select-window 'run -b "~/.config/tmux/scripts/update_inactive_pane_bg.sh \"#{window_id}\""'
set-hook -ag after-select-window 'run -b "~/.config/tmux/scripts/update_pane_border_status.sh \"#{window_id}\""'
set-hook -ag after-select-window 'run -b "~/.config/tmux/scripts/record_window_seen.sh \"#{window_id}\""'
set-hook -ag after-select-window 'run -b "~/.config/tmux/scripts/auto_cancel_copy_mode_near_bottom.sh \"#{hook_pane}\" \"#{pane_id}\""'
set-hook -ag after-select-window 'run -b "tmux set -p -t #{pane_id} @unread_pane_activity 0 >/dev/null 2>&1 || true"'
set-hook -ag after-select-window 'run -b "~/.config/tmux/scripts/sync_window_unread_activity.sh #{window_id} >/dev/null 2>&1 || true"'
set-hook -ag after-select-window 'run -b "~/.config/tmux/scripts/codex_notify_ack_turn_complete.sh #{pane_id} >/dev/null 2>&1 || true"'
set-hook -ag after-select-window 'run -b "tmux set -p -t #{pane_id} @unread_ignore_activity 0 >/dev/null 2>&1 || true"'
set-hook -ag after-select-window 'run -b "tmux set -p -t #{pane_id} @unread_ignore_checked 0 >/dev/null 2>&1 || true"'
set-hook -ag after-select-window 'run -b "tmux set -p -t #{pane_id} @unread_ignore_check_count 0 >/dev/null 2>&1 || true"'
set-hook -ag after-select-window 'run -b "tmux set -p -t #{pane_id} @unread_ignore_checked_at 0 >/dev/null 2>&1 || true"'
set-hook -ag after-split-window 'run -b "~/.config/tmux/scripts/update_inactive_pane_bg.sh \"#{window_id}\""'
set-hook -ag after-kill-pane 'run -b "~/.config/tmux/scripts/update_inactive_pane_bg.sh \"#{window_id}\""'
set-hook -ag after-kill-pane 'run -b "~/.config/tmux/scripts/sync_window_unread_activity.sh \"#{window_id}\""'
set-hook -ag after-new-window 'run -b "~/.config/tmux/scripts/window_rename_from_path.sh \"#{window_id}\" \"#{pane_id}\""'
set-hook -ag after-new-window 'run -b "~/.config/tmux/scripts/update_pane_border_status.sh \"#{window_id}\""'
set-hook -ag after-split-window 'run -b "~/.config/tmux/scripts/update_pane_border_status.sh \"#{window_id}\""'
set-hook -ag after-kill-pane 'run -b "~/.config/tmux/scripts/update_pane_border_status.sh \"#{window_id}\""'
set-hook -ag after-split-window 'if-shell -F "#{&&:#{!=:#{window_panes},1},#{==:#{window_zoomed_flag},0}}" "select-layout -E" ""'
set-hook -ag after-kill-pane 'if-shell -F "#{&&:#{!=:#{window_panes},1},#{==:#{window_zoomed_flag},0}}" "select-layout -E" ""'
set-hook -ag pane-focus-in 'run -b "~/.config/tmux/scripts/update_inactive_pane_bg.sh \"#{window_id}\""'

# Entering copy-mode: switch input method to English (best-effort; macOS).
# NOTE: 先临时禁用：怀疑该类“自动切输入法”的 hook 可能引发 CPU 暴涨（尤其在频繁进出 copy-mode 时）。
# 如需恢复：删掉/注释掉下一行 set-hook -gwu，并取消下面的 set-hook 注释。
set-hook -gwu pane-mode-changed[90]
# set-hook -gw pane-mode-changed[90] 'if-shell -t "#{hook_pane}" -F "#{m:copy-mode*,#{pane_mode}}" "run -b ~/.config/tmux/scripts/tmux_input_method_en.sh" ""'

# set-hook -ag window-linked 'run -b "tmux refresh-client -S"'
# set-hook -ag window-unlinked 'run -b "tmux refresh-client -S"'
# set-hook -ag window-renamed 'run -b "tmux refresh-client -S"'
# set-hook -ag window-layout-changed 'run -b "tmux refresh-client -S"'
# set-hook -ag after-kill-window 'run -b "tmux refresh-client -S"'
#
# set-hook -gu client-session-changed
# set-hook -g client-session-changed 'run -b "tmux refresh-client -S"'
#
set-hook -gu session-created
set-hook -ag session-created 'run -b "~/.config/tmux/scripts/session_created.sh"'
set-hook -ag session-created 'run -b "~/.config/tmux/scripts/ensure_pane_output_watch.sh --all"'
set-hook -ag session-created 'run -b "tmux refresh-client -S"'

set-hook -gu session-renamed
set-hook -g session-renamed 'run -b "tmux refresh-client -S"'

set-hook -gu session-closed
set-hook -g session-closed 'run -b "tmux refresh-client -S"'

run-shell "~/.config/tmux/scripts/session_created.sh"
run-shell "~/.config/tmux/scripts/ensure_pane_output_watch.sh --all"
